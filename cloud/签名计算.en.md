# <center>Signature Calculation</center>

## I. Request Method  
> Supports GET, POST, PUT requests   

GET request supports Content-Type types:
- application/x-www-form-urlencoded

POST and PUT requests support Content-Type types:
- application/json (recommended)
- multipart/form-data (only supported by some interfaces, used for file transfer)  

Public Parameters:
Parameter Name | Type|Required | Description
---|---|---|---
X-IotVideo-AccessID | String| Yes| accessId returned by login, used to identify API caller identity.
X-IotVideo-Nonce | Integer| Yes| Random positive integer, used to prevent replay attacks.
X-IotVideo-Timestamp | Integer| Yes| Current UNIX timestamp, which can record the time when the API request is initiated. For example, 1529223702.<br/>Note: If the time difference from the server exceeds 5 minutes, a signature expiration error will occur
X-IotVideo-Signature | String| Yes| Signature digest

## II. Signature String Splicing (GET Method)     
- HTTP GET request structure example:  
Note: When there are special characters in the requested url, url encoding URLEncoder is required. 
```
https://domain/?userName=aaa&pwd=bbb

header：
Content-Type: application/x-www-form-urlencoded
X-IotVideo-AccessID: dsFAsdf547aSDfasf67GHRrtyTHDGFrtbnkjREt
X-IotVideo-Nonce: 256389
X-IotVideo-Timestamp: 1539084154
X-IotVideo-Signature：AliP9YW3pW46FtyEdkXt/+WcTqP=
```

### 2.1 Sort Parameters
Sort all request parameters in ascending order by parameter name dictionary order (ASCII code). Note:  
> 1) Only sort by parameter name, parameter values remain corresponding, do not participate in comparison  
> 2) When the parameter value is empty, it does not participate in sorting  
> 3) Host parameter participates in sorting

### 2.2. Splice Request String
Splice the request string, format the request parameters sorted in the previous step into the form of "**parameter name:parameter value**", and then concatenate the formatted parameters with "**\n**", the final generated request string **srcStr** is:

```
Host:domain(domain name)
X-IotVideo-AccessID:dsfasdfasdfasf
X-IotVideo-Nonce:246898495
X-IotVideo-Timestamp:1572348036
userName:aaa
pwd:bbb
```
### 2.3. Generate Signature String

```
secretKey = 'Gu5t9xGARNpq86cd98joQYCN3EXAMPLE';
srcStr;
signature = base64_encode(hash_hmac('HmacSHA1', srcStr, secretKey, true));
```
The final signature string is:

```
AliP9YW3pW46FtyEdkXt/+WcTqP=
```

## III. Error Codes
Error Code| Error Description                      |Remarks
------|-------------------------------|--------
10007 |signature validate fail:X      | X is the error code
```
x value reference:
        -1：body acquisition failed
        -2：signature expired
        -3：incorrect signature
```
## IV. Code Example (GET Method)
**Java**

```
import java.util.Random;
import java.util.TreeMap;
import javax.crypto.Mac;
import javax.crypto.spec.SecretKeySpec;
import javax.xml.bind.DatatypeConverter;

public class Sign {

	public static void main(String[] args) throws Exception {
		String host = "www.iotvideo.com";
		String secretId = "dsFAsdf547aSDfasf67GHRrtyTHDGFrtbnkjREt";
		String secretKey = "Gu5t9xGARNpq86cd98joQYCN3EXAMPLE";
		int nonce = new Random().nextInt(java.lang.Integer.MAX_VALUE);
		int timestamp = (int)(System.currentTimeMillis()/1000);
		
		TreeMap<String, Object> params = new TreeMap<>(); // TreeMap can automatically sort
		params.put("pwd", "bbb");//business parameter
		params.put("userName", "aaa");//business parameter
		params.put("Host", host);//public parameter
		params.put("X-IotVideo-AccessID", secretId);//public parameter
		params.put("X-IotVideo-Nonce", nonce);//public parameter
		params.put("X-IotVideo-Timestamp", timestamp);//public parameter
		
		String signature = sign(params,secretKey);
		System.out.println(signature);
	}
	
	public static String sign(TreeMap<String, Object> params, String key) throws Exception {
    	Mac mac = Mac.getInstance("HmacSHA1");
    	SecretKeySpec secretKeySpec = new SecretKeySpec(key.getBytes("UTF-8"), mac.getAlgorithm());
    	mac.init(secretKeySpec);
    	byte[] hash = mac.doFinal(getStringToSign(params).getBytes("UTF-8"));
    	return DatatypeConverter.printBase64Binary(hash);
    }
	
	private static String getStringToSign(TreeMap<String, Object> params) {
        StringBuilder s2s = new StringBuilder();
        // Parameters need to be dictionary sorted when signing, TreeMap is used here to ensure order
        for (String k : params.keySet()) {
            s2s.append(k).append(":").append(params.get(k).toString()).append("\n");
        }
        String str = s2s.toString().substring(0, s2s.length() - 1);
        return str;
    }
}
```

## IV. Signature String Splicing (POST/PUT Method)     
- HTTP POST/PUT request structure example:

```
https://domain

header：
Content-Type: application/json
X-IotVideo-AccessID: 12adsfadf3456
X-IotVideo-Nonce: 256389
X-IotVideo-Timestamp: 1539084154
X-IotVideo-Signature：AliP9YW3pW46FtyEdkXt/+WcTqP=
Payload：{"userName":"aaa","pwd":"bbb"}
```

### 4.1 Sort Parameters
Sort all request parameters in ascending order by parameter name dictionary order (ASCII code). Note:  
> 1) Only sort by parameter name, parameter values remain corresponding, do not participate in comparison  
> 2) The message body body needs to be converted to json, set to the Payload parameter to participate in sorting
> 3) Host parameter participates in sorting

### 4.2. Splice Request String
Splice the request string, format the request parameters sorted in the previous step into the form of "**parameter name:parameter value**", and then concatenate the formatted parameters with "**\n**", the final generated request string **srcStr** is:

```
Host:domain(domain name)
Payload:a040d29ef8e1543fc6fb13b3aa0337fd8b0eecaf56b69623e99f785e6b3a927c
X-IotVideo-AccessID:dsFAsdf547aSDfasf67GHRrtyTHDGFrtbnkjREt
X-IotVideo-Nonce:246898495
X-IotVideo-Timestamp:1572348036
```
**Payload** is the json string of the message body, encrypted by **SHA-256**.

### 4.3. Generate Signature String

```
secretKey = 'Gu5t9xGARNpq86cd98joQYCN3EXAMPLE';
srcStr;
signature = base64_encode(hash_hmac('HmacSHA1', srcStr, secretKey, true));
```
The final signature string is:

```
AliP9YW3pW46FtyEdkXt/+WcTqP=
```
### V. Code Example (POST/PUT Method)
**Java**

```
import java.security.MessageDigest;
import java.util.Random;
import java.util.TreeMap;

import javax.crypto.Mac;
import javax.crypto.spec.SecretKeySpec;
import javax.xml.bind.DatatypeConverter;

import com.alibaba.fastjson.JSON;
import com.example.model.User;

public class Sign {

	public static void main(String[] args) throws Exception {
		String host = "www.iotvideo.com";
		String secretId = "dsFAsdf547aSDfasf67GHRrtyTHDGFrtbnkjREt";
		String secretKey = "Gu5t9xGARNpq86cd98joQYCN3EXAMPLE";
		int nonce = new Random().nextInt(java.lang.Integer.MAX_VALUE);
		int timestamp = (int)(System.currentTimeMillis()/1000);

		User user = new User();
		user.setUserName("aaa");
		user.setPwd("bbb");
		String payloadStr = JSON.toJSONString(user);
		String requestPayload = sha256Hex(payloadStr);
		
		TreeMap<String, Object> params = new TreeMap<>(); // TreeMap can automatically sort
		params.put("Host", host);//public parameter
		params.put("X-IotVideo-AccessID", secretId);//public parameter
		params.put("X-IotVideo-Nonce", nonce);//public parameter
		params.put("X-IotVideo-Timestamp", timestamp);//public parameter
		params.put("Payload", requestPayload);//public parameter
		
		String signature = sign(params,secretKey);
		System.out.println(signature);
	}
	
	public static String sha256Hex(String s) throws Exception {
        MessageDigest md = MessageDigest.getInstance("SHA-256");
        byte[] d = md.digest(s.getBytes("UTF-8"));
        return DatatypeConverter.printHexBinary(d).toLowerCase();
    }
	
	public static String sign(TreeMap<String, Object> params, String key) throws Exception {
    	Mac mac = Mac.getInstance("HmacSHA1");
    	SecretKeySpec secretKeySpec = new SecretKeySpec(key.getBytes("UTF-8"), mac.getAlgorithm());
    	mac.init(secretKeySpec);
    	byte[] hash = mac.doFinal(getStringToSign(params).getBytes("UTF-8"));
    	return DatatypeConverter.printBase64Binary(hash);
    }
	
	private static String getStringToSign(TreeMap<String, Object> params) {
        StringBuilder s2s = new StringBuilder();
        // Parameters need to be dictionary sorted when signing, TreeMap is used here to ensure order
        for (String k : params.keySet()) {
            s2s.append(k).append(":").append(params.get(k).toString()).append("\n");
        }
        String str = s2s.toString().substring(0, s2s.length() - 1);
        return str;
    }
}
```